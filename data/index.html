<html>

<head>
    <meta charset="UTF-8">
    <style>
        .heater-input {
            margin-bottom: 10px;
        }

        .configuration-container {
            margin-top: 50px;
        }

        .configuration-container .form-control {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

    <div id="app" class="container py-5">
        <div class="card-deck mb-4 text-center">
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Półka (10)</h4>
                </div>
                <div class="card-body">
                    <h1 class="card-title pricing-card-title">{{ shelv10 }} <small class="text-muted">°C</small></h1>
                </div>
            </div>
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Głowica</h4>
                </div>
                <div class="card-body">
                    <h1 class="card-title pricing-card-title">{{ header }} <small class="text-muted">°C</small></h1>
                </div>
            </div>
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Zbiornik</h4>
                </div>
                <div class="card-body">
                    <h1 class="card-title pricing-card-title">{{ tank }} <small class="text-muted">°C</small>
                    </h1>
                </div>
            </div>
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Woda</h4>
                </div>
                <div class="card-body">
                    <h1 class="card-title pricing-card-title">{{ water }} <small class="text-muted">°C</small>
                    </h1>
                </div>
            </div>
            <br />



        </div>
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h4 class="my-0 font-weight-normal">Grzałka</h4>
            </div>
            <div class="card-body">
                <h1 class="card-title pricing-card-title">{{ heater }} <small class="text-muted">%</small>
                </h1>
            </div>
            <input class="form-control heater-input" type="number" id="setHeater" v-model="setHeater">
            <input v-on:click="updateHeater" type="button" value="Ustaw"
                class="form-control heater-input btn btn-primary btn-lg btn-block" />
            <input type="range" min="0" max="100" class="slider" v-model="setHeater"
                class="form-control heater-input range-slider">

        </div>

        <div>
            <canvas id="myChart" width="400" height="200"></canvas>
        </div>

        <div class="configuration-container container" id="config">
            <button class="btn btn-outline-secondary" type="button" data-toggle="collapse" data-target="#sensor"
                aria-expanded="false" aria-controls="sensor" v-on:click="refreshSensors">
                Termometry
            </button>
            <button class="btn btn-outline-secondary" type="button" data-toggle="collapse" data-target="#zmienne"
                aria-expanded="false" aria-controls="zmienne">
                Inne
            </button>
            </p>

            <div class="collapse" id="sensor" data-parent="#config">
                <div class="card card-body">
                    <div>
                        <select v-model="shelv10Device" class="form-control form-control-lg">
                            <option disabled value="">10 Półka</option>
                            <option v-for="option in sensorOptions" v-bind:value="option.value">
                                {{ option.text }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <select v-model="headerDevice" class="form-control form-control-lg">
                            <option disabled value="">Głowica</option>
                            <option v-for="option in sensorOptions" v-bind:value="option.value">
                                {{ option.text }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <select v-model="tankDevice" class="form-control form-control-lg">
                            <option disabled value="">Zbiornik</option>
                            <option v-for="option in sensorOptions" v-bind:value="option.value">
                                {{ option.text }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <select v-model="waterDevice" class="form-control form-control-lg">
                            <option disabled value="">Woda</option>
                            <option v-for="option in sensorOptions" v-bind:value="option.value">
                                {{ option.text }}
                            </option>
                        </select>
                    </div>
                    <div class="">
                        <input v-on:click="updateSensors" type="button" value="Ustaw"
                            class="form-control heater-input btn btn-primary btn-lg btn-block" />
                    </div>
                </div>

            </div>
            </p>
            <div class="collapse" id="zmienne" data-parent="#config">
                <div class="card card-body">
                    Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid.
                    Nihil
                    anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.
                </div>
            </div>
        </div>

    </div>





    <script type="module">

        var timeFormat = 'HH:mm:ss';

        var config = {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: "10 Półka",
                        data: [],
                        fill: false,
                        borderColor: 'red'
                    },
                    {
                        label: "Głowica",
                        data: [],
                        fill: false,
                        borderColor: 'blue'
                    },
                    {
                        label: "Zbiornik",
                        data: [],
                        fill: false,
                        borderColor: 'green'
                    },
                    {
                        label: "Woda",
                        data: [],
                        fill: false,
                        borderColor: 'black'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        type: "time",
                        distribution: 'series',
                        time: {
                            tooltipFormat: timeFormat,
                            displayFormats: {
                                second: timeFormat,
                                millisecond: timeFormat,
                                minute: timeFormat

                            }
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Czas'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperatura'
                        }
                    }]
                }
            }
        };

        window.onload = function () {
            var ctx = document.getElementById("myChart").getContext("2d");
            window.myLine = new Chart(ctx, config);
        };

        var app = new Vue({
            el: '#app',
            data: {
                shelv10: 0,
                header: 0,
                tank: 0,
                water: 0,
                heater: 0,
                setHeater: "",
                lastReadTime: 0,
                shelv10Device: "",
                headerDevice: "",
                tankDevice: "",
                waterDevice: "",
                sensorOptions: []

            },
            mounted: function () {
                this.interval = setInterval(() => {
                    axios
                        .get('/data')
                        .then(response => {

                            this.shelv10 = response.data.shelf10;
                            this.header = response.data.header;
                            this.tank = response.data.tank;
                            this.water = response.data.water;
                            this.heater = response.data.heater;

                            if (!this.setHeater) {
                                this.setHeater = this.heater
                            }

                            var currentTime = (new Date()).getTime();
                            if (this.lastReadTime == 0 || (currentTime - this.lastReadTime) > 5000) {
                                window.myLine.data.datasets[0].data.push({
                                    x: new Date(), y: this.shelv10
                                });

                                window.myLine.data.datasets[1].data.push({
                                    x: new Date(), y: this.header
                                });

                                window.myLine.data.datasets[2].data.push({
                                    x: new Date(), y: this.tank
                                });

                                window.myLine.data.datasets[3].data.push({
                                    x: new Date(), y: this.water
                                });

                                this.lastReadTime = currentTime;
                            }



                            window.myLine.update();
                        })
                }, 1000);

                this.refreshSensors();
            },
            methods: {
                updateHeater: function (event) {
                    axios
                        .get('/set', {
                            params: {
                                heater: this.setHeater
                            }
                        })
                },
                updateSensors: function (event) {
                    axios
                        .get('/set', {
                            params: {
                                shelv10Device: this.shelv10Device,
                                headerDevice: this.headerDevice,
                                tankDevice: this.tankDevice,
                                waterDevice: this.shelv10Device,
                            }
                        })
                },
                refreshSensors: function (event) {
                    axios
                        .get('/sensors')
                        .then(response => {
                            this.sensorOptions = response.data;
                        });
                }
            }
        });


    </script>

</body>

</html>